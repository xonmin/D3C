# 09. 커뮤니케이션 패턴 
- 바운디드 컨텍스트 간 커뮤니케이션을 용이하게 
- 애그리게이트 설계 원칙의 제한 사항 해결, 여러 시스템 컴포넌트에 걸쳐 비즈니스 프로세스 조율 역할

## 모델 변환
- 바운디드 컨텍스트 : 유비쿼터스 언어 모델의 경계 
- 만약 다른 바운디드 컨텍스트가 협력할 의향이 있다면?
  - 바운디드 컨텍스트를 파트너십을 통해 통합 가능 : 프로토콜 조정 및 팀간 커뮤니케이션으로 해결 가능
  - 협력 기반 통합 방법 : 공유 커널 방법 사용 (제한된 부분을 공동으로 함께 발전시킴) 

- 업스트림(제공자) / 다운스트림(사용자)
- 이 때 다운스트림이 업스트림의 바운디드 컨텍스트 모델을 따를 수 없을 때 처리 방법은 2가지

1. 다운스트림 측에서 ACL(충돌방지계층) 사용하여 업스트림 모델을 조정하여 사용 
2. 업스트림 측에서 OHS(오픈호스트서비스) 역할을 통해 구현 모델에 대한 병경으로부터 사용자 보호 

그렇다면 모델 변환 로직은? 

### Stateless 모델 변환 
스테이트리스 모델 변환을 소유하는 바운디드 컨텍스트는 **Proxy 디자인 패턴**을 통해 모델 매핑처리
- 업스트림의 경우 : OHS(수신)
- 다운스트림의 경우 : ACL(발신) 

만약 업스트림에서 힘이 없어서 업스트림에서 변환 처리 해줘야 하는 상황
- 다운스트림 -> (요청) -> Proxy(OHS) -> 업스트림 

다운스트림에서 힘이 없어서 본인이 직접 변환 처리 해야해
- 다운스트림 <- (응답) <- Proxy(ACL) <- 업스트림

**StateLess 방식의 동기/비동기 방식**

동기
- OHS : 공용 언어로의 변환은 유입되는 요청을 처리할 때 발생 
- ACL : 업스트림 바운디드 컨텍스트를 호출할 때 발생

- 경우에 따라 변환 로직을 **API 게이트웨이 패턴**과 같은 외부 컴포넌트로 넘기는 것이 효율적일 수 있음 
- OHS 를 구현하는 바운디드 컨텍스트의 경우(업스트림) API게이트웨이는 내부 모델을 통합에 최적화된 공표 언어로 각각 다운스트림 별로 변환하는 역할 수행
- ACL 를 API게이트웨이 패턴을 사용하는 경우 어차피 다운스트림에서 순응하기 떄문에 ACL은 통합 관련 바운디드 컨텍스트 역할을 한다. 
- 이처럼 바운디드 컨텍스트를 편리하게 모델 변환하는 역할을 하므로, **교환 컨텍스트**라고도 명함 


비동기
- OHS 구현시 비동기식 모델 변환은 반드시 필요
- 비동기 변환 사용시 도메인 이벤트를 가로채서 공표된 언어 변환할 수 있으므로 바운디드 컨텍스트의 구현상세를 더 잘 캡슐화할 수 있다(?)
- 메시지를 공표된 언어로 변환시 private event와 public event(다른 바운디드 컨텍스트 연동을 위한) 구분 가능 

**StateFull 모델 변환**
- 데이터 집계(일괄 처리 / 이벤트 통합)시 사용
- 데이터 집계를 통한 모델 변환은 API 게이트 웨이를 사용하여 구현할 수 없음 
- 따라서 들어오는 데이터 추적 및 처리에 대한 변환 로직에 대해 자체 영구 저장소가 필요함 (Proxy 에 별도 storage 필요) 
- 요청 통합에 대한 방법
  - BackEnd-for-frontEnd Pattern 사용 : 사용자 인터페이스가 여러 서비스에서 발생하는 데이터 결합
  - ACL 을 바운디드 컨텍스트 전면에 배치하여 바운디드 컨텍스트 연동과 비즈니스 로직의 복잡성 분리 (ex_ 여러 다른 데이터 처리/복잡한 비즈니스 로직 구현해야하는 바운디드 컨텍스트) 
    
## 애그리게이트 연동
- 애그리게이트에서 바로 도메인 이벤트 발행은 좋지 않음
  - 1. 애그리게이트의 새로운 상태가 DB에 커밋 전에 이벤트가 전달된다. 
  - 2. 경합 조건 : 후속 애그리게이트 로직에 인해 작어비 무효화되거나 단순 DB 문제로 인해 Tx가 커밋되지 않을 수 있음 

- 그렇다면 도메인 이벤트 발행 책임을 어플리케이션 계층으로 이전한다면 (인스턴스 로드 -> 갱신된 상태 DB 커밋 -> 이벤트 발행) 이라면 괜찮을까?
  - 메시지 버스 다운 혹은 이벤트 발행 전 로직 다운 등의 이유로 일관성없을 수 있음 
- **아웃박스 패턴**을 사용해보자 

## 아웃박스 패턴 
